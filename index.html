from __future__ import annotations

import html
import inspect
import re
import textwrap
from datetime import datetime
from pathlib import Path

import gdsfactory as gf

import my_pdk
from my_pdk import components as c


# ----------------------------
# Catalog config (no lambdas)
# ----------------------------
# Each entry: (display_name, function, kwargs)
SECTIONS = [
    (
        "CPW",
        [
            ("straight_cpw", c.straight_cpw, dict(length=200.0)),
            ("bend_cpw_circular", c.bend_cpw_circular, dict(radius_um=80.0, angle_deg=90.0)),
            ("open_stud", c.open_stud, dict(length=6.0, width=22.0)),
        ],
    ),
    (
        "Josephson Junctions",
        [
            ("jj_cross_manhattan", c.jj_cross_manhattan, dict()),
            ("create_jj_cross", c.create_jj_cross, dict()),
            ("create_jj_cross_bar", c.create_jj_cross_bar, dict()),
        ],
    ),
    (
        "Resonators / assemblies",
        [
            ("quarter_wave_resonator", c.quarter_wave_resonator, dict(f_target_GHz=6.0)),
            (
                "quarter_wave_resonator_circular_meander",
                c.quarter_wave_resonator_circular_meander,
                dict(f_target_GHz=7.0),
            ),
            ("meander", c.meander, dict(run_length=200.0, n_turns=5, pitch=100.0, radius=50.0)),
            (
                "meander_from_steps",
                c.meander_from_steps,
                dict(
                    steps=[
                        {"op": "S", "length": 200},
                        {"op": "L", "angle": 90},
                        {"op": "S", "length": 20},
                        {"op": "L", "angle": 90},
                        {"op": "S", "length": 200},
                        {"op": "R", "angle": 90},
                        {"op": "S", "length": 20},
                        {"op": "R", "angle": 90},
                        {"op": "S", "length": 200},
                        {"op": "L", "angle": 90},
                        {"op": "S", "length": 20},
                        {"op": "L", "angle": 90},
                        {"op": "S", "length": 200},
                        {"op": "R", "angle": 90},
                        {"op": "S", "length": 20},
                        {"op": "R", "angle": 90},
                        {"op": "S", "length": 200},
                        {"op": "L", "angle": 45},
                        {"op": "S", "length": 600},
                        {"op": "L", "angle": 45},
                        {"op": "S", "length": 300},
                        {"op": "R", "angle": 90},
                        {"op": "S", "length": 100},
                    ],
                    radius=100.0,
                ),
            ),
            (
                "meander_with_bumps",
                c.meander_with_bumps,
                dict(
                    run_length=6000.0,
                    n_turns=5,
                    pitch=400.0,
                    radius=200.0,
                    bump_radius=50.0,
                    bump_offset=100.0,
                    bump_pitch=500.0,
                    bump_side="both",
                ),
            ),
        ],
    ),
    ("3D objects", [("bump_unit", c.bump_unit, dict(radius=25.0, radius_KOZ=100.0))]),
    (
        "Outline",
        [
            ("chip_outline_4mm", c.chip_outline, dict(size_X_mm=6.0, size_Y_mm=4.0)),
        ],
    ),
    (
        "Couplers Passive",
        [
            (
                "finger cap, period 3",
                c.finger_cap,
                dict(cell_size=(150, 100), carve_out_gap=15, finger_overlap=15, periods=3),
            ),
            (
                "finger cap, period 22",
                c.finger_cap,
                dict(cell_size=(500, 500), carve_out_gap=25, finger_overlap=250, periods=22),
            ),
        ],
    ),
]


def _safe(s: str) -> str:
    return "".join(ch if (ch.isalnum() or ch in "-_") else "_" for ch in s)


# ----------------------------
# Info extraction (gf v7 safe)
# ----------------------------
def info_to_items(comp: gf.Component) -> list[tuple[str, str]]:
    info_obj = getattr(comp, "info", None)

    if info_obj is None:
        return []

    # If it behaves like a mapping
    try:
        out = [(str(k), str(info_obj[k])) for k in info_obj.keys()]  # type: ignore[attr-defined,index]
        if out:
            return sorted(out, key=lambda kv: kv[0])
    except Exception:
        pass

    # If it has to_dict()
    try:
        d = info_obj.to_dict()  # type: ignore[attr-defined]
        if isinstance(d, dict):
            return sorted([(str(k), str(v)) for k, v in d.items()], key=lambda kv: kv[0])
    except Exception:
        pass

    # If it has dict() (pydantic-like)
    try:
        d = info_obj.dict()  # type: ignore[attr-defined]
        if isinstance(d, dict):
            return sorted([(str(k), str(v)) for k, v in d.items()], key=lambda kv: kv[0])
    except Exception:
        pass

    return [("info", str(info_obj))]


# ----------------------------
# Docstring -> markdown-ish HTML
# (no external deps)
# ----------------------------
def get_docstring(fn) -> str | None:
    doc = inspect.getdoc(fn)
    if not doc:
        return None
    return textwrap.dedent(doc).strip()


def md_to_html(md: str) -> str:
    """
    Lightweight markdown-ish renderer:
      - fenced code blocks ```...```
      - inline code `...`
      - bullet lists starting with "- " or "* "
      - "Numpy-style" headings:
            Title
            -----
        becomes <h4>Title</h4>
      - paragraphs
    """
    md = md.replace("\r\n", "\n").replace("\r", "\n")

    # Escape first; we will add tags after
    esc = html.escape(md)

    # Fenced code blocks
    # Convert ```lang?\n...\n``` to <pre><code>...</code></pre>
    def repl_fence(m: re.Match) -> str:
        code = m.group(2)
        return f"<pre class='md-code'><code>{code}</code></pre>"

    esc = re.sub(r"```([^\n]*)\n(.*?)\n```", repl_fence, esc, flags=re.DOTALL)

    # Inline code: `x` -> <code class="md-inline">x</code>
    esc = re.sub(r"`([^`]+)`", r"<code class='md-inline'>\1</code>", esc)

    # Numpy-style headings: line + underline of --- or ===
    lines = esc.split("\n")
    out: list[str] = []
    i = 0
    while i < len(lines):
        line = lines[i].strip()
        if i + 1 < len(lines):
            ul = lines[i + 1].strip()
            if line and (re.fullmatch(r"-{3,}", ul) or re.fullmatch(r"={3,}", ul)):
                out.append(f"<h4 class='md-h'>{lines[i]}</h4>")
                i += 2
                continue
        out.append(lines[i])
        i += 1
    esc = "\n".join(out)

    # Bullet lists: group consecutive "- " or "* "
    lines = esc.split("\n")
    out = []
    in_ul = False
    for raw in lines:
        m = re.match(r"^\s*([-*])\s+(.*)$", raw)
        if m:
            if not in_ul:
                out.append("<ul class='md-ul'>")
                in_ul = True
            out.append(f"<li>{m.group(2)}</li>")
        else:
            if in_ul:
                out.append("</ul>")
                in_ul = False
            out.append(raw)
    if in_ul:
        out.append("</ul>")
    esc = "\n".join(out)

    # Paragraphs: split by blank lines, but keep our block tags intact
    chunks = re.split(r"\n\s*\n", esc)
    rendered: list[str] = []
    for ch in chunks:
        ch_strip = ch.strip()
        if not ch_strip:
            continue
        # If chunk starts with a block tag, keep it
        if re.match(r"^\s*<(pre|ul|h4)\b", ch_strip):
            rendered.append(ch_strip)
        else:
            # Convert single newlines to <br> inside paragraph
            rendered.append("<p class='md-p'>" + ch_strip.replace("\n", "<br>") + "</p>")
    return "\n".join(rendered)


def main() -> None:
    # Activate PDK
    pdk = my_pdk.get_pdk()
    pdk.activate()

    # Output folders
    out_root = Path("docs_site")
    out_assets = out_root / "assets" / "cells"
    out_assets.mkdir(parents=True, exist_ok=True)

    # Your layer-stack YAML (sits in my_pdk/)
    yaml_path = Path(__file__).resolve().parents[1] / "layer_stack_cinnamon.yaml"
    if not yaml_path.exists():
        print(f"[WARN] layer stack yaml not found at: {yaml_path}")

    # Import the matplotlib renderer
    from my_pdk.tools.render_gds_to_png_matplotlib import render_gds_to_png

    cards_html: list[str] = []

    for section_title, entries in SECTIONS:
        sec_slug = _safe(section_title.lower())

        # Section header block (collapsible group)
        cards_html.append(
            f"""
            <button class="section" type="button" data-section="{sec_slug}" aria-expanded="true">
              <div class="section-title">{html.escape(section_title)}</div>
              <div class="section-line"></div>
              <div class="section-caret" aria-hidden="true">▾</div>
            </button>
            """
        )

        for name, fn, kwargs in entries:
            slug = _safe(name)
            png_path = out_assets / f"{slug}.png"
            gds_path = out_assets / f"{slug}.gds"
            doc_id = f"doc-{slug}"

            status = "ok"
            info_html = ""
            doc_html = ""

            try:
                comp = fn(**kwargs)

                # Export GDS
                comp.write_gds(gds_path)

                # Render PNG from GDS (matplotlib pipeline)
                if "bump" in name:
                    print(f"[INFO] Rendering with bump annotations: {name}")
                    render_gds_to_png(
                        gds_path=gds_path,
                        png_path=png_path,
                        layer_stack_yaml=yaml_path if yaml_path.exists() else None,
                        annotate_bumps=True,
                        bump_marker_layer=(900, 25),
                        bump_label_fmt="KOZ ⌀={d:.0f} µm",
                    )
                else:
                    print(f"[INFO] Rendering: {name}")
                    render_gds_to_png(
                        gds_path=gds_path,
                        png_path=png_path,
                        layer_stack_yaml=yaml_path if yaml_path.exists() else None,
                        default_alpha_unknown=0.2,
                        annotate_bumps=False,
                    )

                # Doc block (markdown-ish)
                doc = get_docstring(fn)
                if doc:
                    doc_html = md_to_html(doc)
                else:
                    doc_html = "<div class='muted'>No docstring</div>"

                # Info items
                items = info_to_items(comp)
                info_html = (
                    "".join(
                        f"<div class='kv'><span class='k'>{html.escape(k)}</span><span class='v'>{html.escape(v)}</span></div>"
                        for k, v in items
                    )
                    or "<div class='muted'>No cell info</div>"
                )

            except Exception as e:
                status = "fail"
                doc_html = "<div class='muted'>Doc unavailable</div>"
                info_html = f"<pre class='error'>{html.escape(str(e))}</pre>"

            title = html.escape(name)

            img_block = (
                f"<img class='thumb' src='assets/cells/{slug}.png' alt='{title}'>"
                if png_path.exists() and png_path.stat().st_size > 1000
                else "<div class='thumb thumb-missing'>No preview</div>"
            )

            gds_link = (
                f"<a class='btn' href='assets/cells/{slug}.gds' download>Download GDS</a>"
                if gds_path.exists()
                else "<span class='btn btn-disabled'>GDS unavailable</span>"
            )

            cards_html.append(
                f"""
                <section class="card" id="{slug}" data-section="{sec_slug}">
                  <div class="card-top">
                    <div>
                      <h2>{title}</h2>
                      <div class="meta">
                        <span class="pill {"ok" if status == "ok" else "fail"}">{status.upper()}</span>
                        <span class="mono">/{slug}</span>
                      </div>
                    </div>
                    <div class="actions">
                      {gds_link}
                    </div>
                  </div>

                  <div class="card-body">
                    <div class="preview">{img_block}</div>

                    <div class="info">
                      <div class="info-head">
                        <h3>Cell Info</h3>
                        <button class="doc-toggle" type="button" aria-expanded="false" aria-controls="{doc_id}">
                          Doc <span class="doc-caret" aria-hidden="true">▾</span>
                        </button>
                      </div>

                      <div id="{doc_id}" class="doc md" hidden>
                        {doc_html}
                      </div>

                      <div class="kvlist">{info_html}</div>
                    </div>
                  </div>
                </section>
                """
            )

    now = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
    html_doc = f"""<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>PDK Cells Catalog</title>
<style>
  :root {{
    --bg: #0b0f14;
    --panel: #121823;
    --panel2: #0f1520;
    --text: #e9eef7;
    --muted: #9aa7bd;
    --border: rgba(255,255,255,0.08);
    --ok: #2bd576;
    --fail: #ff5c5c;
    --btn: #1f2a3a;
  }}
  * {{ box-sizing: border-box; }}
  body {{
    margin: 0;
    font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
    background: radial-gradient(1200px 800px at 20% 0%, #152034 0%, var(--bg) 60%);
    color: var(--text);
  }}
  header {{
    padding: 28px 20px 10px;
    max-width: 1100px;
    margin: 0 auto;
  }}
  h1 {{
    margin: 0 0 6px;
    font-size: 24px;
    letter-spacing: 0.2px;
  }}
  .sub {{
    margin: 0;
    color: var(--muted);
    font-size: 13px;
  }}
  .wrap {{
    max-width: 1100px;
    margin: 0 auto;
    padding: 16px 20px 40px;
  }}
  .toolbar {{
    display: flex;
    gap: 10px;
    align-items: center;
    justify-content: space-between;
    padding: 12px 14px;
    background: rgba(18,24,35,0.65);
    border: 1px solid var(--border);
    border-radius: 12px;
    backdrop-filter: blur(10px);
    margin-bottom: 14px;
  }}
  .search {{
    width: 380px;
    max-width: 100%;
    padding: 10px 12px;
    border-radius: 10px;
    border: 1px solid var(--border);
    background: var(--panel2);
    color: var(--text);
    outline: none;
  }}
  .grid {{
    display: grid;
    grid-template-columns: 1fr;
    gap: 14px;
  }}
  .card {{
    background: rgba(18,24,35,0.75);
    border: 1px solid var(--border);
    border-radius: 14px;
    overflow: hidden;
  }}
  .card-top {{
    display: flex;
    align-items: start;
    justify-content: space-between;
    gap: 12px;
    padding: 14px 14px 10px;
    border-bottom: 1px solid var(--border);
  }}
  h2 {{
    margin: 0;
    font-size: 16px;
  }}
  .meta {{
    margin-top: 6px;
    display: flex;
    gap: 8px;
    align-items: center;
    color: var(--muted);
    font-size: 12px;
  }}
  .mono {{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; }}
  .pill {{
    padding: 2px 8px;
    border-radius: 999px;
    font-size: 11px;
    border: 1px solid var(--border);
  }}
  .pill.ok {{ color: var(--ok); border-color: rgba(43,213,118,0.35); }}
  .pill.fail {{ color: var(--fail); border-color: rgba(255,92,92,0.35); }}
  .actions {{ display: flex; gap: 8px; }}
  .btn {{
    display: inline-block;
    padding: 8px 10px;
    border-radius: 10px;
    background: var(--btn);
    border: 1px solid var(--border);
    color: var(--text);
    text-decoration: none;
    font-size: 12px;
  }}
  .btn:hover {{ filter: brightness(1.08); }}
  .btn-disabled {{ opacity: 0.5; }}
  .card-body {{
    display: grid;
    grid-template-columns: 420px 1fr;
    gap: 12px;
    padding: 12px 14px 14px;
  }}
  @media (max-width: 900px) {{
    .card-body {{ grid-template-columns: 1fr; }}
  }}
  .preview {{
    background: rgba(15,21,32,0.7);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 10px;
    min-height: 220px;
    display: flex;
    align-items: center;
    justify-content: center;
  }}
  .thumb {{
    width: 100%;
    height: auto;
    display: block;
    border-radius: 8px;
  }}
  .thumb-missing {{
    width: 100%;
    border-radius: 8px;
    color: var(--muted);
    text-align: center;
    padding: 30px 10px;
  }}
  .info h3 {{
    margin: 0;
    font-size: 13px;
    color: var(--muted);
    letter-spacing: 0.2px;
  }}

  .info-head {{
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 10px;
    margin-bottom: 8px;
  }}

  .doc-toggle {{
    display: inline-flex;
    gap: 8px;
    align-items: center;
    padding: 6px 10px;
    border-radius: 10px;
    background: rgba(15,21,32,0.55);
    border: 1px solid var(--border);
    color: var(--text);
    font-size: 12px;
    cursor: pointer;
  }}
  .doc-toggle:hover {{ filter: brightness(1.08); }}

  .doc-caret {{
    color: var(--muted);
    display: inline-block;
    transform: rotate(-90deg);
    transition: transform 120ms ease;
  }}
  .doc-toggle[aria-expanded="true"] .doc-caret {{
    transform: rotate(0deg);
  }}

  .doc {{
    margin-bottom: 10px;
    padding: 10px 12px;
    border-radius: 12px;
    background: rgba(15,21,32,0.45);
    border: 1px solid var(--border);
  }}

  /* markdown-ish styling */
  .md-h {{
    margin: 0 0 8px;
    font-size: 12px;
    letter-spacing: 0.04em;
    color: var(--text);
  }}
  .md-p {{
    margin: 0 0 8px;
    font-size: 12px;
    line-height: 1.5;
    color: var(--text);
  }}
  .md-ul {{
    margin: 0 0 8px 18px;
    padding: 0;
    font-size: 12px;
    line-height: 1.5;
  }}
  .md-code {{
    margin: 0 0 8px;
    padding: 10px 12px;
    border-radius: 10px;
    border: 1px solid rgba(255,255,255,0.10);
    background: rgba(0,0,0,0.25);
    overflow: auto;
  }}
  .md-code code {{
    font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
    font-size: 11px;
    color: var(--text);
  }}
  .md-inline {{
    padding: 1px 6px;
    border-radius: 8px;
    border: 1px solid rgba(255,255,255,0.10);
    background: rgba(0,0,0,0.25);
    font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
    font-size: 11px;
  }}

  .kvlist {{
    background: rgba(15,21,32,0.55);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 10px;
  }}
  .kv {{
    display: grid;
    grid-template-columns: 220px 1fr;
    gap: 10px;
    padding: 6px 0;
    border-bottom: 1px dashed rgba(255,255,255,0.08);
    font-size: 12px;
  }}
  .kv:last-child {{ border-bottom: none; }}
  .k {{ color: var(--muted); font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace; }}
  .v {{ color: var(--text); word-break: break-word; }}
  .muted {{ color: var(--muted); font-size: 12px; }}
  .error {{
    margin: 0;
    white-space: pre-wrap;
    color: var(--fail);
    font-size: 12px;
  }}
  footer {{
    max-width: 1100px;
    margin: 0 auto;
    padding: 16px 20px 28px;
    color: var(--muted);
    font-size: 12px;
  }}

  /* section headers (collapsible) */
  .section {{
    margin-top: 18px;
    padding: 10px 6px 6px;
    display: flex;
    align-items: center;
    gap: 12px;
    width: 100%;
    cursor: pointer;
    border: none;
    background: transparent;
    text-align: left;
  }}
  .section:focus {{
    outline: 2px solid rgba(255,255,255,0.18);
    outline-offset: 4px;
    border-radius: 12px;
  }}
  .section-title {{
    font-size: 13px;
    color: var(--muted);
    letter-spacing: 0.12em;
    text-transform: uppercase;
    font-weight: 650;
    padding: 6px 10px;
    border: 1px solid var(--border);
    border-radius: 999px;
    background: rgba(15,21,32,0.35);
    backdrop-filter: blur(6px);
  }}
  .section-line {{
    height: 1px;
    flex: 1;
    background: rgba(255,255,255,0.10);
  }}
  .section-caret {{
    margin-left: auto;
    color: var(--muted);
    font-size: 14px;
    transform: rotate(0deg);
    transition: transform 120ms ease;
  }}
  .section[aria-expanded="false"] .section-caret {{
    transform: rotate(-90deg);
  }}
</style>
</head>
<body>
<header>
  <h1>PDK Cells Catalog</h1>
  <p class="sub">Generated: {html.escape(now)} • Build: static HTML (matplotlib renderer)</p>
</header>

<div class="wrap">
  <div class="toolbar">
    <input id="q" class="search" placeholder="Filter cells by name (e.g. meander, resonator, cpw)..." />
    <div class="sub mono">{html.escape(pdk.name if hasattr(pdk, "name") else "my_pdk")}</div>
  </div>

  <div id="grid" class="grid">
    {"".join(cards_html)}
  </div>
</div>

<footer>
  <div>Tip: Host <span class="mono">docs_site/</span> on GitHub Pages or any static host.</div>
</footer>

<script>
  const q = document.getElementById('q');
  const cards = Array.from(document.querySelectorAll('.card'));
  const sections = Array.from(document.querySelectorAll('.section'));

  // Track collapsed state by section id
  const collapsed = new Map(); // secId -> bool

  function isCardMatch(card, query) {{
    const name = card.querySelector('h2').innerText.toLowerCase();
    return (!query || name.includes(query));
  }}

  function applyFilterAndCollapse() {{
    const s = q.value.toLowerCase().trim();

    // 1) show/hide cards based on search + collapsed state
    for (const card of cards) {{
      const secId = card.getAttribute('data-section');
      const match = isCardMatch(card, s);
      const isCollapsed = collapsed.get(secId) === true;
      const show = match && !isCollapsed;
      card.style.display = show ? '' : 'none';
    }}

    // 2) show/hide section headers if they have any matching cards at all
    for (const sec of sections) {{
      const secId = sec.getAttribute('data-section');
      const anyMatch = cards.some(c => c.getAttribute('data-section') === secId && isCardMatch(c, s));
      sec.style.display = anyMatch ? '' : 'none';

      // keep aria-expanded in sync
      const isCollapsed = collapsed.get(secId) === true;
      sec.setAttribute('aria-expanded', isCollapsed ? 'false' : 'true');
    }}
  }}

  // click to toggle section
  for (const sec of sections) {{
    sec.addEventListener('click', () => {{
      const secId = sec.getAttribute('data-section');
      collapsed.set(secId, !(collapsed.get(secId) === true)); // toggle
      applyFilterAndCollapse();
    }});
  }}

  // per-card Doc toggle
  const docToggles = Array.from(document.querySelectorAll('.doc-toggle'));
  for (const btn of docToggles) {{
    btn.addEventListener('click', (ev) => {{
      ev.preventDefault();
      ev.stopPropagation(); // don't trigger section toggle

      const targetId = btn.getAttribute('aria-controls');
      const el = document.getElementById(targetId);
      const expanded = btn.getAttribute('aria-expanded') === 'true';

      btn.setAttribute('aria-expanded', expanded ? 'false' : 'true');
      if (el) {{
        el.hidden = expanded; // hide when expanded=true -> collapsing
      }}
    }});
  }}

  q.addEventListener('input', applyFilterAndCollapse);

  // init (all expanded)
  applyFilterAndCollapse();
</script>

</body>
</html>
"""

    out_html = out_root / "cells.html"
    out_html.write_text(html_doc, encoding="utf-8")
    print(f"[OK] Wrote: {out_html.resolve()}")
    print(f"[OK] Assets: {out_assets.resolve()}")


if __name__ == "__main__":
    main()
